---
title: "Raw Regression"
output: github_document
---

```{r}
library(tidyverse)
library(readxl)

knitr::opts_chunk$set(
  fig.width = 9,
  fig.asp = .6,
  out.width = "90%")
```

We planned to use linear regression model to analysis the association between obesity rate and other variables like sex, grade level, economic status, etc. The resulting model can give us a sense of which factor influences obesity rate the most. 

Basic variables that we are interested in:

**Sex**
**Grade Level**
**Economic Status**
**Food Access Ability**


# Exploratory data analysis

## Sex

The graph below shows that more male students are in the overweight or obese category each year than female students.It seems like the percentage for male in the overweight or obese category slightly decreases and female slightly increases over years. 

```{r}
original = 
  tibble(
  read.csv("./dataset/Student_Weight_Status_Category_Reporting_Results__Beginning_2010.csv")
) %>%
  janitor::clean_names()

sex_df = 
  original %>% 
  mutate(
    percent_healthy_weight = percent_healthy_weight * 100
  ) %>% ## when importing data the percent healthy weight was distorted so i timed 100
  select(county, region, year_reported, percent_overweight_or_obese, grade_level, sex) %>% 
  filter(sex == "MALE" | sex == "FEMALE") %>%
  filter(grade_level == "DISTRICT TOTAL") %>% 
  filter(county == "STATEWIDE (EXCLUDING NYC)") %>% 
  select(year_reported, percent_overweight_or_obese, sex)

sex_count = 
  sex_df %>% 
  group_by(year_reported) 

sex_count %>% 
  ggplot(aes(x = as.factor(year_reported), y = percent_overweight_or_obese, fill = sex)) +
  geom_bar(stat='identity', position = "dodge") +
  labs(title = "Gender distribution in the database",
       x = "Year Reported",
       y = "percentage of Overweight or Obese") +
  theme(axis.text.x = element_text(angle = 45, hjust = 1))
  

```



## Grade Level

The graph below shows that students in middle/high school grade level tend to have higher percentage than the elementary students in overweight or obese category each year. There also seems to be an increase in the overweight or obese percentage for the middle or high school students while a decrease for the elementary students over years. 

```{r}
grade_df = 
  original %>% 
  select(county, region, year_reported, percent_overweight_or_obese, grade_level, sex) %>% 
  filter(sex %in% "ALL") %>% 
  filter(grade_level %in% c("ELEMENTARY", "MIDDLE/HIGH")) %>% 
  filter(county == "STATEWIDE (EXCLUDING NYC)") %>% 
  select(year_reported, percent_overweight_or_obese, grade_level)
  
grade_count = 
  grade_df %>% 
  group_by(year_reported)
  
grade_count %>% 
  ggplot(aes(x = as.factor(year_reported), y = percent_overweight_or_obese, fill = grade_level)) +
  geom_bar(stat='identity', position = "dodge") +
  labs(title = "Grade level distribution in the database",
       x = "Year Reported",
       y = "percentage of Overweight or Obese") +
  theme(axis.text.x = element_text(angle = 45, hjust = 1))
```


## Economic Status

```{r echo=FALSE} 
# Clean data set with geo location information
coordinates = tibble(
  read.csv("./dataset/Geocodes_USA_with_Counties.csv")
) %>%
  filter(state == "NY") %>%  # filter out counties outside NY state
  select(county, latitude, longitude) %>% # only information we need is county name and geo location
  drop_na() %>%
  group_by(county) %>%
  summarise(latitude = mean(latitude), longitude = mean(longitude)) %>% #different location in each county varied slightly, so we take the mean of each county's geo location
  filter(!county == "") %>% # one county's name input is blank
  mutate(county = toupper(county)) # to switch county name to uppercase
```

```{r echo=FALSE}
# combine two data set
weight_df = left_join(original, coordinates, by = "county")
```

```{r}
# Further original data cleaning for linear regression analysis
linear_df = weight_df %>%
  filter(!sex == "ALL") %>%
  filter(!grade_level == "DISTRICT TOTAL") %>%
  mutate(
    sex = if_else(sex == "MALE", 0, 1),
    grade_level = if_else(grade_level == "ELEMENTARY", 0, 1)
  ) %>%
  drop_na() %>%
  filter(year_reported %in% c("2018-2019")) %>% #only analyzing data in year 2018-2019
  select(county, percent_overweight_or_obese, grade_level, sex)


# Import tidy and join the median income and food insecurity data
income = read_xlsx("./dataset/median_income.xlsx") %>%
  janitor::clean_names() %>%
  rename(county = region_county) %>%
  mutate(median_income = median_income*0.001,  # convert the income unit from $100,000 to 100k format, large values will reduce model's efficiency
         county = toupper(county))

food_insecurity = read_xlsx("./dataset/food_insecurity.xlsx") %>%
  janitor::clean_names() %>%
    rename(county = region_county) %>%
  rename(food_insecurity_p = percentage) %>%
  mutate(county = toupper(county))

linear_df2 = left_join(linear_df, income, by = "county")  # combine income data to the main 
linear_df3 = left_join(linear_df2, food_insecurity, by = "county") # combine food insecurity data
```

## Food Access Ability

