---
title: "Raw Regression"
output: html_document
---

```{r, include=FALSE,message=FALSE,echo=FALSE}
library(tidyverse)
library(readxl)
library(plotly)

knitr::opts_chunk$set(
  fig.width = 9,
  fig.asp = .6,
  out.width = "90%")

theme_set(theme_minimal() + theme(legend.position = "bottom"))

options(
  ggplot2.continuous.colour = "viridis",
  ggplot2.continuous.fill = "viridis"
)

scale_colour_discrete = scale_color_viridis_d
scale_fill_discrete = scale_fill_viridis_d
```

We planned to use linear regression model to analysis the association between obesity rate and other variables like sex, grade level, economic status, etc. The resulting model can give us a sense of which factor influences obesity rate in teenagers the most. 

# Data

The main data set for our project is a data set from The Student Weight Status Category Reporting System (SWSCR). SWSCR collects weight status category data and includes separate estimates of the percent of students overweight, obese and overweight or obese for all reportable grades within the county and/or region and by grade groups (elementary and middle/high). It can be accessed at [here](https://health.data.ny.gov/Health/Student-Weight-Status-Category-Reporting-Results-B/es3k-2aus). This dataset has a range from 2010 to 2019. 

We also combined three extra datasets to examine the factors of economic status and food access ability on weight status. Economic status dataset can be accessed [here](https://webbi1.health.ny.gov/SASStoredProcess/guest?_program=/EBI/PHIG/apps/chir_dashboard/chir_dashboard&p=it&ind_id=Ng100).
Food access ability dataset can be accessed [here](https://webbi1.health.ny.gov/SASStoredProcess/guest?_program=/EBI/PHIG/apps/chir_dashboard/chir_dashboard&p=it&ind_id=Ng123).
Race dataset can be accessed [here](https://labor.ny.gov/stats/nys/statewide-population-data.shtm).



Basic variables that we are interested in:

- **Sex**: Female and male
- **Grade Level**: Elementary, Middle/High
- **Weight Status**: Underweight, health weight, overweight or obese based on BMI for age percentile. For this project, we focus on the overweight or obese student percentage which are estimates of based on all reportable grades within the county and/or region and by grade groups. 
- **Economic Status**
- **Food Access Ability**
- **Race**



# Exploratory data analysis

## Sex

The graph below shows that more male students are in the overweight or obese category each year than female students.It seems like the percentage for male in the overweight or obese category slightly decreases and female slightly increases over years. 

```{r, echo=FALSE}
original = 
  tibble(
  read.csv("./dataset/Student_Weight_Status_Category_Reporting_Results__Beginning_2010.csv")
) %>%
  janitor::clean_names()

sex_df = 
  original %>% 
  mutate(
    percent_healthy_weight = percent_healthy_weight * 100
  ) %>% ## when importing data the percent healthy weight was distorted so i timed 100
  select(county, region, year_reported, percent_overweight_or_obese, grade_level, sex) %>% 
  filter(sex == "MALE" | sex == "FEMALE") %>%
  filter(grade_level == "DISTRICT TOTAL") %>% 
  filter(year_reported %in% c("2015-2016", "2016-2017")) %>% #only analyzing data in year 2015 and 2016
  select(year_reported, percent_overweight_or_obese, sex) %>% 
  pivot_wider(
    names_from = "sex",
    values_from = "percent_overweight_or_obese"
  ) %>% 
  unnest()

sex_count = 
  sex_df %>% 
  group_by(year_reported) %>% 
  drop_na() %>% 
  summarize(
    female = mean(FEMALE),
    male = mean(MALE)
    ) %>% 
  pivot_longer(
    female:male,
    names_to = "sex",
    values_to = "percent_overweight_or_obese"
  )

sex_count %>% 
  ggplot(aes(x = as.factor(year_reported), y = percent_overweight_or_obese, fill = sex)) +
  geom_bar(stat='identity', position = "dodge") +
  labs(title = "Gender distribution in the database",
       x = "Year Reported",
       y = "percentage of Overweight or Obese") +
  theme(axis.text.x = element_text(angle = 45, hjust = 1))
```



## Grade Level

The graph below shows that students in middle/high school grade level tend to have higher percentage than the elementary students in overweight or obese category each year. There also seems to be an increase in the overweight or obese percentage for the middle or high school students while a decrease for the elementary students over years. 

```{r, echo=FALSE}
grade_df = 
  original %>% 
  select(county, region, year_reported, percent_overweight_or_obese, grade_level, sex) %>% 
  filter(sex %in% "ALL") %>% 
  filter(grade_level %in% c("ELEMENTARY", "MIDDLE/HIGH")) %>% 
  filter(county == "STATEWIDE (EXCLUDING NYC)") %>% 
  select(year_reported, percent_overweight_or_obese, grade_level)
  
grade_count = 
  grade_df %>% 
  group_by(year_reported)
  
grade_count %>% 
  ggplot(aes(x = as.factor(year_reported), y = percent_overweight_or_obese, fill = grade_level)) +
  geom_bar(stat='identity', position = "dodge") +
  labs(title = "Grade level distribution in the database",
       x = "Year Reported",
       y = "percentage of Overweight or Obese") +
  theme(axis.text.x = element_text(angle = 45, hjust = 1))
```


## Economic Status

```{r,echo=FALSE,warning=FALSE}
income = read_xlsx("./dataset/median_income.xlsx") %>%
  janitor::clean_names() %>%
  rename(county = region_county) %>%
  mutate(median_income = median_income*0.001,  # convert the income unit from $100,000 to 100k format, large values will reduce model's efficiency
         county = toupper(county)) 


obesity = 
  original %>% 
  filter(sex %in% "ALL") %>% 
  filter(!county == "STATEWIDE (EXCLUDING NYC)") %>% 
  filter(grade_level %in% "DISTRICT TOTAL") %>% 
  filter(!county == "N/A") %>% 
  select(county, percent_overweight_or_obese) %>% 
  group_by(county) %>% 
  summarize(percent_overweight_or_obese = mean(percent_overweight_or_obese)) %>% 
  mutate(
    percent_overweight_or_obese = round(percent_overweight_or_obese, 3)
  )


combine = 
  left_join(income, obesity, by = "county")


combine %>% 
  mutate(text_label = str_c("Overweight or obese: (%) ", percent_overweight_or_obese, "\nMedian income: (k)", median_income)) %>% 
  plot_ly(x = ~percent_overweight_or_obese, y = ~median_income, 
          text = ~text_label, 
          type = 'scatter', 
          mode = 'markers', 
          color = ~county, 
          sizes = c(1, 10000), 
          marker = list(size = ~percent_overweight_or_obese, opacity = 0.6, sizemode = 'diameter')) %>% 
  layout(
    title = "Median income vs overweight or obese distribution", 
    yaxis = list(title = "Meidan income (k)"),
    xaxis = list(title = "Overweight or obese percent (%)")
  )

```

From the graph we can see that there is a general trend that if the median income is low, the overweight or obese percent in students are higher. Two of the most richest county in NY have the least percentage in overweight or obese student. 


## Food Access Ability

```{r, echo=FALSE,warning=FALSE}
#import food insecurity data
food_insecurity = read_xlsx("./dataset/food_insecurity.xlsx") %>%
  janitor::clean_names() %>%
  rename(county = region_county) %>%
  rename(food_insecurity_p = percentage) %>%
  mutate(county = toupper(county))



#combine with obesity data
combine2 = 
  left_join(food_insecurity, obesity, by = "county")



combine2 %>% 
  mutate(text_label = str_c("Overweight or obese: (%) ", percent_overweight_or_obese, "\nFood insecurity: (%)", food_insecurity_p)) %>% 
  plot_ly(x = ~percent_overweight_or_obese, y = ~food_insecurity_p, 
          text = ~text_label, 
          type = 'scatter', 
          mode = 'markers', 
          color = ~county, 
          sizes = c(1, 10000), 
          marker = list(size = ~percent_overweight_or_obese, opacity = 0.6, sizemode = 'diameter')) %>% 
  layout(
    title = "Food insecurity vs overweight or obese distribution", 
    yaxis = list(title = "Food insecurity (%)"),
    xaxis = list(title = "Overweight or obese percent (%)")
  )
```

From the graph we can see that there is a general trend that if food insecurity percentage is high, the the overweight or obese percent in students are higher. Two of the counties with the lowest food insecurity percentage in NY have the least percentage in overweight or obese student. 


## Race

```{r, echo=FALSE, message=FALSE}
census_data = read_excel("dataset/census_data.xls",  
    sheet = "Pop by Race and Ethnic Origin", 
    range = "A3:BM10") 

race_df = as.data.frame(t(as.matrix(census_data)))[-1,] 
race_df = setNames(cbind(rownames(race_df), race_df, row.names = NULL), 
         c("county", "total", "white", "black", "native", "asian", "hawaiian", "mix"))
race_df = 
  tibble(race_df) %>%
  janitor::clean_names() %>%
  mutate(
    total = as.numeric(total),
    white = as.numeric(white) / total * 100,
    black = as.numeric(black)/ total * 100,
    native = as.numeric(native)/ total * 100,
    asian = as.numeric(asian)/ total * 100,
    hawaiian = as.numeric(hawaiian)/ total * 100,
    mix = as.numeric(mix)/ total * 100) %>%
  select(-total) %>%
  filter(!county %in% c("United States", "New York State")) %>%
  separate(county, into = c("county", "county1")) %>%
  select(-county1) %>%
  mutate(county = toupper(county))

#combine with obesity data
combine3 = 
  left_join(race_df, obesity, by = "county") %>% 
  pivot_longer(
    white:mix,
    names_to = "race",
    values_to = "percent") %>% 
  group_by(county) %>% 
  pivot_wider(
    names_from = "race",
    values_from = "percent"
  ) #%>% 
 # mutate()
  #arrange(percent_overweight_or_obese) %>% 
 # mutate(
   # county = factor(percent_overweight_or_obese, levels = unique[order(precentage)]decreasing = TRUE)
  
  

combine3 %>% 
  plot_ly(x = ~county, y = ~white, type = 'bar') %>% 
  add_trace(y = ~black, type = 'bar') %>%
  add_trace(y = ~native, type = 'bar') %>% 
  add_trace(y = ~asian, type = 'bar') %>% 
  add_trace(y = ~hawaiian, type = 'bar') %>% 
  add_trace(y = ~mix, type = 'bar') %>% 
  add_trace(y = ~percent_overweight_or_obese, type = 'scatter', mode = 'lines', line = list(color = 'rgb(22, 96, 167)', width = 4, dash = 'dot')) %>% 
  #layout(barmode = 'stack') %>% 
  add_trace(y = ~percent_overweight_or_obese, type = 'scatter', mode = 'lines+markers') %>% 
  layout(
    xaxis = list(title = "County"),
    yaxis = list(title = "Obese and overweigth percent(%)")
    #yaxis = list(categoryorder = "array", categoryarray = ecomm_yoy2$YOY)) 
  )

```



## Correlation graph

```{r}
#cor(patient_df)


#cor(combine4)
```

